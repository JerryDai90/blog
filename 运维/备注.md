# 备注

### 1、修改root密码

```shell
sudo passwd
```

### 2、安装 vim

```shell
sudo apt update
sudo apt install vim
```

### 3、在Ubuntu上启用SSH

```shell
sudo apt install openssh-server
```

　　查看状态

```shell
sudo systemctl status ssh
```

### 4、配置 root ssh 可以使用登录

　　详情看：https://www.jianshu.com/p/e2c49128126f

```shell
sudo vim /etc/ssh/sshd_config
```

### 5、安装 lsof

```shell
sudo apt install lsof
```

### 6、修改ssh端口为 1122

```shell
sudo vim /etc/ssh/sshd_config
```

　　修改为

```
Port 1122
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::
```

```shell
sudo service ssh restart
```

### 7、安装文件

　　containerd.io_1.3.9-1_amd64.deb
docker-ce-cli_19.03.14_3-0_ubuntu-focal_amd64.deb
docker-ce_19.03.14_3-0_ubuntu-focal_amd64.deb

　　安装所有deb

```
sudo dpkg -i *
```

### 8、开启自启动

```shell
systemctl enable docker
```

### 9、docker 镜像名称修改

　　先load镜像，然后在更改名字

```shell
docker tag 6c2f6f26e44b mysql:8.0.21 
docker tag 9d0b2d0794b7 redis:6.0.9
```

### 10、docker 配置文件

　　vim /etc/docker/daemon.json

```json
{
  "registry-mirrors": [
    "https://registry.docker-cn.com",
    "http://hub-mirror.c.163.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://wevl6ekf.mirror.aliyuncs.com"
  ],"insecure-registries":["127.0.0.1:5000"],
  "log-driver":"json-file",
  "log-opts": {"max-size":"100m", "max-file":"3"}
}
```

```shell
systemctl restart docker
```

### 11、拉取镜像命令

　　插上公安网拉取镜像

```shell
docker pull 68.208.6.61:5000/kinth_qd_hikvision:latest
docker pull 68.208.6.61:5000/kinth_qd_gate:latest
docker pull 68.208.6.61:5000/kinth_qd_gate_gunmgr:latest
docker pull 68.208.6.61:5000/cabinet_agent:latest
docker pull 68.208.6.61:5000/containrrr/watchtower:latest
```

### 12、数据库用户脚本（可以不需要改）,可以不执行

　　CREATE USER `gate`@`%` IDENTIFIED BY 'kinth@2021';

　　GRANT Alter, Alter Routine, Create, Create Routine, Create Temporary Tables, Create View, Delete, Drop, Event, Execute, Grant Option, Index, Insert, Lock Tables, References, Select, Show View, Trigger, Update ON `gate`.* TO `gate`@`%`;

　　GRANT Alter, Alter Routine, Create, Create Routine, Create Temporary Tables, Create User, Create View, Delete, Drop, Event, Execute, File, Grant Option, Index, Insert, Lock Tables, Process, References, Reload, Replication Client, Replication Slave, Select, Show Databases, Show View, Shutdown, Super, Trigger, Update ON *.* TO `gate`@`%`;

　　ALTER USER 'gate'@'%' IDENTIFIED WITH mysql_native_password BY 'kinth@2021';

### 13、禁止工控机休眠

　　https://blog.csdn.net/ciel_yu/article/details/117130048

```shell
sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
```

### 14、 创建虚拟机网络

　　由于目前工控机上大部分服务都需要相互访问，可以预先创建一个网络端，然后再给相关容器分配IP

```shell
docker network create --subnet=172.18.0.0/24 localhost
```

> 如果之前已经创建了localhost 网络，需要先删除掉
> 删除前，需要先清除所有使用的容器 docker network rm localhost
>

### 机柜程序docker run脚本

　　重新删除 kinth_qd_gate_gunmgr、cabinet_agent 容器，并且移除 /home/docker/kinth_qd_gate_gunmgr、
/home/docker/cabinet_agent 配置文件

> 可以先修改名字，然后没问题后在删除
>

```sh
docker run -itd --name kinth_qd_gate_gunmgr  \
-v /home/docker/kinth_qd_gate_gunmgr/config:/kinth_qd_gate_gunmgr/config \
--network  localhost  \
--ip 172.18.0.3   \
-p 8182:8182 --restart=always   68.208.6.61:5000/kinth_qd_gate_gunmgr
```

```sh
docker run -itd --name cabinet_agent  \
-v /home/docker/cabinet_agent/config:/cabinet_agent/config  \
--network  localhost  \
--ip 172.18.0.4   \
-p 8181:8181 -p 8234:8234   --restart=always  68.208.6.61:5000/cabinet_agent
```

> 如果有配置虚拟网络的，建议在excel 中标明具体的ip地址。
>

```sh
docker run --restart=always -p 8379:6379 --name redis  \
-v /home/docker/redis/conf/redis.conf:/etc/redis/redis.conf  \
-v /home/docker/redis/data:/data  \
--network  localhost  \
--ip 172.18.0.5   \
-d redis:6.0.9 redis-server /etc/redis/redis.conf --appendonly yes
```

```sh
docker run --name mysql -p 3307:3306 -e MYSQL_ROOT_PASSWORD='kinth@2021'  \
-v /home/docker/mysql/conf/my.cnf:/etc/mysql/my.cnf  \
-v /home/docker/mysql/data:/var/lib/mysql   \
-v /home/docker/mysql/mysql-files:/var/lib/mysql-files/  \
-v /home/docker/mysql/logs/audit_logs.log:/var/lib/mysql/audit_logs.log  \
--network  localhost  \
--ip 172.18.0.6   \
--restart=always -d mysql:8.0.21
```

### 限制docker 日志大小
