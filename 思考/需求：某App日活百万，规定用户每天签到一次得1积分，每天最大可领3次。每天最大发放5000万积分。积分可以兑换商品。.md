## 1. 关键的提取

* **日活百万**：用户量大，需要考虑高性能和存储空间问题。
* **5000 万积分**：需要做资源消费的控制，类是于秒杀的感觉。如果按 12 小时计算，TPS 需要大于 1568 。
* **每天大领取 3 次**：需要记录用户领取的次数。

## 2. 解决方案

### 2.1 方案一

　　采用 Redis + mysql + RabbitMQ 来实现。原因有：有并发锁要求，所以采用 Redis 锁，mysql 为持久化积分数据，rabbitMQ 为持久化延迟使用。

　　以下为详细设计

1. 考虑到日活百万用户，所以存储用户签到数据需要注意。因此采用位图的方式进行存储（计算 1000 万的数据值存储只需要 3.5MB）。采用三位（bit）来记录数据，0 表示未签到，1 表示已签到。
2. 数据需要每天清理则创建的时候设在过期时间（当天的数据在第二天凌晨 12 点整就会被清除掉）

### 2.2 方案一

　　如何实现一致性，就算 hang 机器了也存储到了数据

　　CAP，高可用、一致性

1. 总积分数如何保证每个都被消费？
2. 总积分数如何与用户绑定？也即是说我消费了积分，但是发现写入失败，
3. 强制同步方案
   1. 先淘汰缓存，插入数据库，再次淘汰缓存（二次淘汰最大程度保证缓存和数据库一致）
      插入数据库采用分表方式，插入最少的列，保证数据最大的可靠性

   可靠性验证：积分总数和消费的一致
   1. 先进入到消息队列，等待消息队列

## 几个点的高可用

1. 总积分数：需要设计出扣减的高可用，高性能，高可靠。
   方案一
   采用 redis cluster

　　如何把数据均衡？

　　如何初始化热数据？

　　采用每个用户记录每天采用 3bit 来记录签到信息

　　如何保证消息的可靠性传输？
Q：生产者 ACK，如果高可用强调，那就需要刷到磁盘后在消费

　　要是消息丢了怎么办？

　　如何保证消息的顺序性

　　如何保证消息队列的高可用
